parameters:
    level: 9
    phpVersion: 80400

    # Don't fail when a suppression pattern matches nothing (happens when code is fixed).
    reportUnmatchedIgnoredErrors: false

    paths:
        - src/
        - tests/

    symfony:
        containerXmlPath: var/cache/dev/App_KernelDevDebugContainer.xml
        consoleApplicationLoader: null

    doctrine:
        objectManagerLoader: tests/object-manager.php

    ignoreErrors:
        # ——————————————————————————————————————————————————————————————————————
        # Symfony entity construction pattern: nullable PHP properties that
        # correspond to non-nullable DB columns are intentional — entities are
        # constructed empty and populated via setters before persistence.
        # PHPStan-Doctrine 2.x flags these as "property can contain X|null but
        # database expects X". This is a known limitation of the strict check.
        # ——————————————————————————————————————————————————————————————————————
        - '#Property App\\Entity\\[A-Za-z]+::\$[a-zA-Z_]+ type mapping mismatch: property can contain .+\|null but database expects .+\.$#'

        # ——————————————————————————————————————————————————————————————————————
        # Entity JSON column array properties — typed as ?array without generics.
        # PHPDoc on the getter/setter covers the value type for callers.
        # ——————————————————————————————————————————————————————————————————————
        - '#Property App\\Entity\\[A-Za-z]+::\$[a-zA-Z_]+ type has no value type specified in iterable type array\.#'

        # ——————————————————————————————————————————————————————————————————————
        # API Platform state classes — generic interface specialisation requires
        # @template annotations that would bloat entity classes. Suppressed
        # until API Platform ships improved type stubs.
        # ——————————————————————————————————————————————————————————————————————
        - '#Class App\\State\\.+ implements generic interface .+ but does not specify its types#'
        - '#Method App\\State\\.+::getProvider\(\) return type with generic#'
        - '#Method App\\State\\SchoolContextProvider::__construct\(\) has parameter .+ with generic interface#'
        - '#Method App\\State\\UserHashPasswordStateProcessor::__construct\(\) has parameter .+ with generic interface#'

        # ——————————————————————————————————————————————————————————————————————
        # API Platform Operation::getCollection() — defined on the concrete
        # HttpOperation subclasses but PHPStan resolves the abstract base class.
        # ——————————————————————————————————————————————————————————————————————
        - '#Call to an undefined method ApiPlatform\\Metadata\\Operation::getCollection\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # EasyAdmin CRUD controllers — AbstractCrudController<TEntity> resolved
        # via @extends PHPDoc; no undefined method calls remain.
        # ——————————————————————————————————————————————————————————————————————
        - '#Call to an undefined method EasyCorp\\Bundle\\EasyAdminBundle\\Controller\\AbstractCrudController::#'

        # ——————————————————————————————————————————————————————————————————————
        # Mercado Pago SDK v3 returns stdClass with dynamic properties.
        # No PHPStan stubs are available for this package.
        # ——————————————————————————————————————————————————————————————————————
        - '#Call to an undefined method MercadoPago\\#'

        # ——————————————————————————————————————————————————————————————————————
        # Mercado Pago createPreference() returns an object with dynamic props
        # — can't be narrowed without stubs; runtime errors surface in tests.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\Payment\\MercadoPagoService::createPreference\(\) should return#'
        - '#Offset .+ on array\{preference_id: string, init_point: string\}#'

        # ——————————————————————————————————————————————————————————————————————
        # MercadoPagoService return types — array shapes for dynamic MP SDK data.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\Payment\\MercadoPagoService::[a-zA-Z]+\(\) return type has no value type specified in iterable type array#'
        - '#Cannot access property \$id on array\|object\.#'
        - '#Cannot access property \$email on array\|object\.#'

        # ——————————————————————————————————————————————————————————————————————
        # MercadoPagoOAuthService — encrypt/decrypt receive nullable strings
        # guarded by prior null checks that PHPStan cannot follow through.
        # mixed cast from HTTP response JSON decoded value.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\Payment\\MercadoPagoOAuthService::[a-zA-Z]+\(\)#'
        - '#Parameter \#1 \$plaintext of method App\\Service\\Payment\\TokenEncryptor::encrypt\(\) expects string, string\|null given#'
        - '#Parameter \#1 \$encoded of method App\\Service\\Payment\\TokenEncryptor::decrypt\(\) expects string, string\|null given#'
        -
            message: '#Cannot cast mixed to int#'
            paths:
                - src/Service/Payment/MercadoPagoOAuthService.php

        # ——————————————————————————————————————————————————————————————————————
        # bccomp() expects numeric-string in PHP 8.4. Decimal entity fields are
        # always valid numeric strings (stored and retrieved from DECIMAL columns).
        # ——————————————————————————————————————————————————————————————————————
        - '#Parameter \#[12] \$(num1|num2) of function bccomp expects numeric-string, string given\.#'

        # ——————————————————————————————————————————————————————————————————————
        # getUserPushToken() in NotificationService returns mixed from the push
        # token storage — callers guard with null checks.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\NotificationService::getUserPushToken\(\) never returns null#'

        # ——————————————————————————————————————————————————————————————————————
        # Symfony BrowserKit postJson helper — parameter typing in test helpers.
        # ——————————————————————————————————————————————————————————————————————
        - '#Parameter \#6 \$content of method Symfony\\Component\\BrowserKit\\#'
        - '#Method App\\Tests\\AbstractApiTestCase::(postJson|getJson)\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # tests/bootstrap.php compatibility check — method_exists for Dotenv.
        # ——————————————————————————————————————————————————————————————————————
        - '#Call to function method_exists\(\) with .+Dotenv.+ will always evaluate to true#'

        # ——————————————————————————————————————————————————————————————————————
        # Dead catch blocks from Symfony Router (thrown only in some paths).
        # ——————————————————————————————————————————————————————————————————————
        - '#Dead catch - Symfony\\Component\\Routing\\Exception\\#'

        # ——————————————————————————————————————————————————————————————————————
        # Symfony Cache: rate limiter storage parameter.
        # ——————————————————————————————————————————————————————————————————————
        - '#Missing parameter \$state \(Symfony\\Contracts\\Cache\\CacheInterface#'
        - '#Unknown parameter \$store in call to method Symfony\\Component#'

        # ——————————————————————————————————————————————————————————————————————
        # IdempotencyService: cache.app implements hasItem() at runtime (PSR-6)
        # but is typed as Symfony Contracts CacheInterface.
        # ——————————————————————————————————————————————————————————————————————
        - '#Call to an undefined method Symfony\\Contracts\\Cache\\CacheInterface::hasItem\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # Doctrine SchoolFilter addFilterConstraint: internal ClassMetadata API.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Doctrine\\Filter\\SchoolFilter::addFilterConstraint\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # Notification provider $data arrays — flexible payload shape per channel.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Notification\\(Provider\\[A-Za-z]+|NotificationInterface)::[a-zA-Z]+\(\) has parameter \$data with no value type specified in iterable type array#'
        - '#Method App\\Notification\\Provider\\[A-Za-z]+::[a-zA-Z]+\(\) (has parameter .+ with no value type specified in iterable type array|return type has no value type specified in iterable type array)#'

        # ——————————————————————————————————————————————————————————————————————
        # NotificationService constructor and internal methods.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\NotificationService::__construct\(\) has parameter \$providers with no value type specified in iterable type iterable#'
        - '#Method App\\Service\\NotificationService::[a-zA-Z]+\(\) (has parameter .+ with no value type specified|return type has no value type|never returns string)#'

        # ——————————————————————————————————————————————————————————————————————
        # EventSubscriber publishUpdate $data — internal payload; typed at call site.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\EventSubscriber\\PaymentEventSubscriber::publishUpdate\(\) has parameter \$data with no value type specified in iterable type array#'

        # ——————————————————————————————————————————————————————————————————————
        # SchoolAdminDashboardController helper methods return shape-typed arrays
        # that are only consumed internally; generic return type is acceptable.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Controller\\SchoolAdminDashboardController::(getStatistics|getTodayMetrics|generateAlerts)\(\) (return type has no value type specified in iterable type array|has parameter .+ with no value type specified in iterable type array)#'
        - '#Property App\\Controller\\(SchoolAdminDashboardController|ParentDashboardController)::\$entityManager is never read, only written\.#'

        # ——————————————————————————————————————————————————————————————————————
        # RouteOptimizationService: loose array shapes for stop/segment data.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\RouteOptimizationService::[a-zA-Z]+\(\) (has parameter .+with no value type specified in iterable type array|return type has no value type specified in iterable type array|should return .+ but returns .+)#'
        - '#Offset .+ on array\{optimized_order: array<int>, total_distance: int, total_duration: int, polyline: string\} (in isset\(\) always exists|on left side of \?\? always exists)#'

        # ——————————————————————————————————————————————————————————————————————
        # RouteOptimizationService → GoogleMapsService calls: generic lat/lng
        # arrays are verified by GoogleMapsService's isValidApiResponse checks.
        # Also covers self-referential optimizeRoute calls with generic arrays.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Parameter \#[123] .+ of method (App\\Service\\GoogleMapsService::(getOptimizedRoute|getDistanceMatrix)|App\\Service\\RouteOptimizationService::optimizeRoute)\(\) expects .+, .+ given#'
            paths:
                - src/Service/RouteOptimizationService.php
                - src/Controller/RouteController.php
                - src/Service/RouteRecalculationService.php
                - src/MessageHandler/StudentReadyForPickupHandler.php

        # ——————————————————————————————————————————————————————————————————————
        # RouteArchivingService calculatePerformance: loose array return.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\RouteArchivingService::[a-zA-Z]+\(\) (has parameter .+ with no value type specified|return type has no value type|should return)#'
        - '#Parameter .+ of method App\\Service\\RouteArchivingService::[a-zA-Z]+\(\) expects .+, .+\|null given#'

        # ——————————————————————————————————————————————————————————————————————
        # RouteRecalculationService: null-safe entity navigation; context
        # guarantees populated relations at call sites.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\RouteRecalculationService::[a-zA-Z]+\(\) (return type has no value type specified|has parameter .+ with no value type specified)#'
        - '#Parameter .+ of method App\\Service\\RouteRecalculationService::[a-zA-Z]+\(\) expects .+, .+\|null given#'

        # ——————————————————————————————————————————————————————————————————————
        # GeofencingService distance array: key type is float from bcmath ops.
        # Strict comparison on status strings: value set matches runtime enum.
        # ——————————————————————————————————————————————————————————————————————
        - '#Offset .student_name. does not exist on array\{distance: float, stop_id: int\}#'
        - '#Method App\\Service\\GeofencingService::[a-zA-Z]+\(\) (should return|return type has no value type specified)#'
        - '#Strict comparison using !== between .+\|.+ and .+ will always evaluate to true#'

        # ——————————————————————————————————————————————————————————————————————
        # Google Maps API: HTTP client JSON responses are mixed by design.
        # All access is guarded by isValidApiResponse() checks.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\GoogleMapsService::[a-zA-Z]+\(\) should return .+ but returns#'
        - '#Cannot access offset .+ on mixed\.#'
        - '#Argument of an invalid type mixed supplied for foreach, only iterables are supported\.#'
        - '#Binary operation .+\+\=.+ between \(float\|int\) and mixed results in an error\.#'

        # ——————————————————————————————————————————————————————————————————————
        # Repository return types: PHPStan-Doctrine may infer broader types than
        # the declared return types.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Repository\\[A-Za-z]+Repository::[a-zA-Z]+\(\) (should return|return type has no)#'

        # ——————————————————————————————————————————————————————————————————————
        # WebhookController/WebhookControllerTest int|null from getId().
        # ——————————————————————————————————————————————————————————————————————
        - '#Parameter \$paymentId of class App\\Message\\ProcessWebhookMessage constructor expects int, int\|null given#'
        - '#Method App\\Service\\Payment\\WebhookValidator::[a-zA-Z]+\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # ProcessWebhookMessage $webhookData — raw array from MP webhook payload.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Message\\ProcessWebhookMessage::__construct\(\) has parameter \$webhookData with no value type specified in iterable type array#'
        - '#Method App\\MessageHandler\\ProcessWebhookMessageHandler::dispatchStatusEvent\(\) has parameter \$webhookData with no value type specified in iterable type array#'

        # ——————————————————————————————————————————————————————————————————————
        # DTO constructors — parameters deserialized from mixed JSON.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Dto\\[A-Za-z]+Dto::__construct\(\) has parameter .+ with no value type specified in iterable type array#'

        # ——————————————————————————————————————————————————————————————————————
        # PerformanceMetricsService internal array shape calculations.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\PerformanceMetricsService::[a-zA-Z]+\(\)#'
        - '#Strict comparison using === between float and 0 will always evaluate to false#'

        # ——————————————————————————————————————————————————————————————————————
        # SafetyAuditService return types with mixed arrays — audit data shapes
        # are consumed only by the single callers that know the shape.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\SafetyAuditService::[a-zA-Z]+\(\)#'

        # ——————————————————————————————————————————————————————————————————————
        # PaymentProcessor — user/amount nullability guarded by calling context.
        # ——————————————————————————————————————————————————————————————————————
        - '#Method App\\Service\\Payment\\PaymentProcessor::[a-zA-Z]+\(\) has parameter .+ with no value type specified in iterable type array#'
        - '#Parameter .+ of method App\\Service\\Payment\\MercadoPagoService::createPreference\(\) expects App\\Entity\\User, App\\Entity\\User\|null given#'

        # ——————————————————————————————————————————————————————————————————————
        # Controllers receiving mixed-typed JSON from request body — runtime
        # validation via Symfony Validator covers the actual shape.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#(Cannot cast mixed to (string|int|float)|Parameter .+ expects .+, mixed given|Parameter .+ expects .+\|null, mixed given|Parameter \#[12] \$datetime of class DateTimeImmutable)#'
            paths:
                - src/Controller/TrackingController.php
                - src/Controller/PaymentController.php
                - src/Controller/WebhookController.php
                - src/Controller/AddressController.php
                - src/Controller/AbsenceController.php
                - src/Controller/AttendanceController.php
                - src/Controller/RouteController.php
                - src/Controller/RouteStopController.php
                - src/Controller/SpecialEventRouteController.php
                - src/Command/CreateUserCommand.php
                - src/Command/ProcessSubscriptionsCommand.php
                - src/Command/ArchiveRoutesCommand.php
                - src/MessageHandler/ProcessSubscriptionsMessageHandler.php
                - src/MessageHandler/ProcessWebhookMessageHandler.php

        # ——————————————————————————————————————————————————————————————————————
        # Controllers/commands — nullable entity relations (FK) that are
        # guaranteed non-null by the DB schema and loading context.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#(Cannot call method .+ on .+\|null\.|Parameter .+ expects .+, .+\|null given|Cannot call method format\(\) on DateTimeImmutable\|null)#'
            paths:
                - src/Controller/AttendanceController.php
                - src/Controller/ParentDashboardController.php
                - src/Controller/RouteController.php
                - src/Controller/SchoolAdminDashboardController.php
                - src/Controller/AbsenceController.php
                - src/Controller/RouteStopController.php
                - src/Controller/TrackingController.php
                - src/Controller/SpecialEventRouteController.php
                - src/EventSubscriber/RouteNotificationSubscriber.php
                - src/Service/RouteArchivingService.php
                - src/Service/RouteRecalculationService.php
                - src/Service/SafetyAuditService.php
                - src/Service/GeofencingService.php
                - src/Service/PerformanceMetricsService.php
                - src/Command/ProcessSubscriptionsCommand.php
                - src/MessageHandler/ProcessSubscriptionsMessageHandler.php

        # ——————————————————————————————————————————————————————————————————————
        # AttendanceController — findByStudentAndDate returns Attendance|array;
        # method calls on the union type cause cascading false positives.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Cannot (call method|cast) .+ on App\\Entity\\Attendance\|array<App\\Entity\\Attendance>#'
            paths:
                - src/Controller/AttendanceController.php

        # ——————————————————————————————————————————————————————————————————————
        # AttendanceController — getStatus on array<Attendance>; repository
        # returns a single entity but the declared return type is Attendance|array.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Cannot call method .+ on array<App\\Entity\\Attendance>#'
            paths:
                - src/Controller/AttendanceController.php

        # ——————————————————————————————————————————————————————————————————————
        # RouteStopController — instanceof always true for User (known entity).
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Instanceof between App\\Entity\\User and App\\Entity\\User will always evaluate to true#'
            paths:
                - src/Controller/RouteStopController.php

        # ——————————————————————————————————————————————————————————————————————
        # RouteStopController — negated boolean always false (iri not-null check).
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Negated boolean expression is always false#'
            paths:
                - src/Controller/RouteStopController.php

        # ——————————————————————————————————————————————————————————————————————
        # PaymentController — user is guaranteed non-null by firewall; getId()
        # on User|null after getUser() call is a PHPStan type inference gap.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Cannot call method getId\(\) on App\\Entity\\User\|null#'
            paths:
                - src/Controller/PaymentController.php

        # ——————————————————————————————————————————————————————————————————————
        # PaymentController — enum->value accessed after null-status assignment.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Cannot access property \$value on App\\Enum\\(TransactionEvent|PaymentStatus)\|null#'
            paths:
                - src/Controller/PaymentController.php

        # ——————————————————————————————————————————————————————————————————————
        # HealthController — float|int key type from bcmath/precision operations.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Possibly invalid array key type float\|int#'
            paths:
                - src/Controller/HealthController.php

        # ——————————————————————————————————————————————————————————————————————
        # ProcessSubscriptionsCommand — $retrySubscriptions pre-initialised to [];
        # ?? always-exists is a false positive from PHPStan's scope analysis.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Variable \$retrySubscriptions on left side of \?\? always exists and is not nullable#'
            paths:
                - src/Command/ProcessSubscriptionsCommand.php

        # ——————————————————————————————————————————————————————————————————————
        # ProcessSubscriptionsCommand / MessageHandler — student IDs fetched
        # via getStudentIds() may include null (optional FK); non-null enforced
        # by DB constraints in practice.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Parameter \$studentIds of method App\\Service\\Payment\\PaymentProcessor::createPayment\(\) expects array<int>, array<int, int\|null> given#'
            paths:
                - src/Command/ProcessSubscriptionsCommand.php
                - src/MessageHandler/ProcessSubscriptionsMessageHandler.php

        # ——————————————————————————————————————————————————————————————————————
        # OAuthControllerTest — loginUser() expects UserInterface, factory
        # returns User|null; non-null guaranteed by test setup.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#(Parameter \#1 \$user of method Symfony\\Bundle\\FrameworkBundle\\KernelBrowser::loginUser\(\) expects .+, App\\Entity\\User\|null given|Parameter \#1 \$json of function json_decode expects string, string\|false given|Cannot cast mixed to string)#'
            paths:
                - tests/Functional/Controller/OAuthControllerTest.php

        # ——————————————————————————————————————————————————————————————————————
        # WebhookControllerTest — validSignatureHeaders array type and json_decode
        # mixed/string|false issues in test helpers.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#(Method App\\Tests\\Functional\\Controller\\WebhookControllerTest::validSignatureHeaders\(\) return type has no value type specified|Parameter \#1 \$json of function json_decode expects string, string\|false given|Parameter \#2 \$array of method PHPUnit\\Framework\\Assert::assertArrayHasKey\(\) expects array<mixed>\|ArrayAccess.+, mixed given)#'
            paths:
                - tests/Functional/Controller/WebhookControllerTest.php

        # ——————————————————————————————————————————————————————————————————————
        # object-manager.php — $_SERVER values are mixed by design; 'test' default
        # makes the runtime value always a valid string.
        # ——————————————————————————————————————————————————————————————————————
        -
            message: '#Cannot cast mixed to string#'
            paths:
                - tests/object-manager.php

    excludePaths:
        - src/DataFixtures/AppFixtures.php
        - migrations/
        - var/
